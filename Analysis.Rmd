---
title: "R-code for the paper 'Conceptualizing and quantifying body condition using structural equation modelling: A user guide.' (Frauendorf et al.)"
author: "Magali Frauendorf"
date: "25-08-2021"
output: word_document
---

```{r, setup, include=F}
knitr::opts_knit$set(root.dir = 'P:/CHIRP/Manuscripts/Magali/Chp 2 - Methodological SEM/Submission process/JAE/11_Proofing/CodesGithub/QuantifyingBodyConditionWithSEM')
```

Abbreviations for the variables in all R-codes. All Statistical analyses  were done with R-version 3.5.1. \
ratio: ratio of mass divided by tarsus length\
MS: mass\
TA: tarsus length\
TH: head length\
WL: wing length\
FC: fat reserves\
BCol: bill colour\
LS: bill luminance\
CS: bill chroma\
HS: bill hue\
Comp: composite variable=body condition\
LogitSurvWS: Survival\
Density: Oystercatcher density (number/km2)\
SexN: Sex (numeric variable)\
nBH: standardized bill tip height (mean=0, sd=1)\
nHT: standardized handling time and squared handling time (mean=0, sd=1)\
CortStd: Corticosterone\
U_perVolBlood: Uric acid\
Cho_perVolBlood: Cholesterol\
LogitH: Haematocrit\
LogitB: Buffy coat\
BS: Body size (latent variable)\
Residuals: Residuals of mass (Mass ~ wing length + tarsus length + head length)

Import packages (versions are shown behind the #)
```{r, include=F}
library(car) #3.0-2
library(caret) #6.0-86 
library(colorspace) #2.0-1
library(corrplot) #0.89
library(dplyr) #1.0.6
library(egg) #0.4.5
library(factoextra) #1.0.7 
library(FactoMineR) #2.3
library(ggfortify) #0.4.5
library(ggplot2) #3.3.5 
library(ggpubr) #0.4.0
library(grid) #3.5.1
library(gridExtra) #2.3
library(knitr) #1.30
library(lattice) #0.20-35
library(lavaan) #0.6-8 
library(patchwork) #1.1.1
library(plyr) #1.8.6
library(tidyr) #1.1.3
library(tidyverse) #1.3.1 
library(unikn) #0.2.0
```

Import data and prepare data for analysis
```{r, include=FALSE}
data<-read.csv("data.csv", header=T,dec=",", sep=";") 

str(data)

# select only adults and sub adults
d<-subset(data,Age=="Adult" |  Age=="Sub-Adult")

##### change unit cho and uric acid
xyplot(H~Cho, data=d,type=c("r", "p"))
cor(d$H,d$Cho, use="complete.obs")#0.28

xyplot(H~U, data=d,type=c("r", "p"))
cor(d$H,d$U, use="complete.obs")#0.19

d$H_B<-d$H+d$B
summary(d$H_B)
d$Cho_perVolBlood<-(d$Cho)/(1-d$H_B)
head(d)
xyplot(H~Cho_perVolBlood, data=d,type=c("r", "p"))
cor(d$H, d$Cho_perVolBlood, use="complete.obs")#0.53

d$U_perVolBlood<-(d$U)/(1-d$H_B)
xyplot(H~U_perVolBlood, data=d,type=c("r", "p"))
cor(d$H, d$U_perVolBlood, use="complete.obs")#0.28
cor(d$Cho_perVolBlood, d$U_perVolBlood, use="complete.obs")

#### standardize CORT for year of analysis
Cort2016<-subset(d, SY=="2016_2017",
                 select=c(BirdId, Cort))
Cort2016$CortStd<-(Cort2016$Cort-(mean(Cort2016$Cort,na.rm=T)))/(sd(Cort2016$Cort, na.rm=T))
summary(Cort2016$CortStd)
mean(Cort2016$CortStd, na.rm=T)
sd(Cort2016$CortStd, na.rm=T)
Cort2016<-na.omit(Cort2016)

Cort2017<-subset(d, SY=="2017_2018",
                 select=c(BirdId, Cort))
Cort2017$CortStd<-(Cort2017$Cort-(mean(Cort2017$Cort,na.rm=T)))/(sd(Cort2017$Cort, na.rm=T))
summary(Cort2017$CortStd)
mean(Cort2017$CortStd, na.rm=T)
sd(Cort2017$CortStd, na.rm=T)
Cort2017<-na.omit(Cort2017)

Cort2016_2018<-rbind(Cort2016, Cort2017)
Cort2016_2018<-subset(Cort2016_2018,
                      select=c(BirdId,CortStd))
d<-left_join(d, Cort2016_2018, by="BirdId") 

#### histogram voor supplements corticosterone ###
Cort2016$Year<-"2016-2017"
Cort2017$Year<-"2017-2018"
CortSuppl<-rbind(Cort2016, Cort2017)

mean(Cort2016$Cort)
sd(Cort2016$Cort)
min(Cort2016$Cort)
max(Cort2016$Cort)

mean(Cort2017$Cort)
sd(Cort2017$Cort)
min(Cort2017$Cort)
max(Cort2017$Cort)
mean <- c(4.2,10.8)
Year <- c("2016-2017", "2017-2018")
mu<-data.frame(mean, Year)
mu
```

#############################################################################################################################
############################################################ section 1: latent variables ####################################
#############################################################################################################################

############################################# Energy store ##################################################################

Select relevant variables for this dataset
```{r include=F}
f<-subset(d, select=c(SexN,WL,TA, TH,AgeN,MS))
f<-na.omit(f) #n=1021

#ratio
f$ratio<-f$MS/f$TA

#residuals
m2<-lm(MS~TA+WL+TH, data=f)
f$Residuals<-resid(m2)
f$Residuals<-f$Residuals/1000
```

Code S1: The code shows the code for Figue 2b. The error variance of ratio turns out to be negative (but really close to 0) so that it is acceptable to fix the error variance of the variable ratio to 0. The R-package used for the analysis is lavaan.
```{r warning=F}
lvmod.1 <-'
ES =~ ratio + Residuals  #=~ annotation for defining latent variable Energy store
Residuals~~0*Residuals
'

lvmod.1.fit<-cfa(lvmod.1,data=f) #fits the model
summary(lvmod.1.fit, rsq=T, standardized=T)  #gives model output
fitMeasures(lvmod.1.fit, c("chisq", "pvalue", "df","cfi", "srmr", "rmsea", "rmsea.ci.lower", "rmsea.ci.upper")) #gives model fit indices

```

```{r}
fitMeasures(lvmod.1.fit, c("gfi", "agfi", "cfi", "rni", "srmr", "rmsea", "pvalue", "BIC"))
```

```{r include=F}
## get the predicted values of the latent variable
s<-lavPredict(lvmod.1.fit)
s1<-data.frame(s) #save as data frame
```

Create a PCA of energy stores 
```{r include=F}
## PCA energy store from residuals and ratio
par(mfrow=c(1,1))
PCA_Fat<-data.frame(f$Residuals,f$ratio) 

colnames(PCA_Fat) <- c("Residuals", "Ratio")

res.pca<-PCA(PCA_Fat, scale.unit = TRUE, ncp = 5, graph = TRUE)
print(res.pca)
eig.val <- get_eigenvalue(res.pca)
eig.val
get_eigenvalue(res.pca) #Extract the eigenvalues/variances of principal components

res.pca$var$cor

fviz_pca_var(res.pca, col.var = "black", repel=F, labelsize=3)+
  theme(
    axis.title = element_text(size = 10),
    axis.text = element_text(size = 8))+
  labs(title="", x="PC1 (96.6%)", y="PC2 (3.4%)")
```

Check the correlation between the PC1 and the latent variable for energy stores
```{r include=F}
axes_Fat1<-res.pca$ind
axes_Fat<-data.frame(axes_Fat1$coord) #save PCA as data frame
corFat <- cbind(s1, axes_Fat) #add PCA to latent variable (s1)
corFat$PC1_Fat<-corFat$Dim.1 #save PC1 as PC1_Fat
str(corFat)
cor(corFat$ES, corFat$PC1_Fat)
plot(corFat$ES, corFat$PC1_Fat)
FigS8a<-ggplot(corFat, aes(x=ES, y=PC1_Fat)) +
  geom_point(size=1.5)+
  labs(x = "CFA", y="PCA")+
  ggtitle("Correlation of energy store")
FigS8a
```

```{r echo=F}
LoadingsFat<-res.pca$var$coord
kable(LoadingsFat,digits=2, format="pandoc", caption="Table S4: Loadings from PC1 and PC2 of the fat-reserve-PCA. PCA analyses were conducted with the R-package FactoMineR.")
```

```{r echo = FALSE,fig.width=4,fig.height=4, fig.cap="\\label{fig:figs}Figure S3: Visualisation of the fat-reserve-PCA. PCA visualization was conducted with the R-package factoextra {(Kassambara, 2020 #1153)}."}
fviz_pca_var(res.pca, col.var = "black", repel=F, labelsize=3)+
  theme(
    axis.title = element_text(size = 10),
    axis.text = element_text(size = 8))+
  labs(title="", x="PC1 (96.6%)", y="PC2 (3.4%)")
```

############################################# Bill colour ######################################################################
Import and prepare data
```{r, include=FALSE}
data<-read.csv("data.csv", header=T,dec=",", sep=";") 

str(data)

# select only adults and sub adults
d<-subset(data,Age=="Adult" |  Age=="Sub-Adult")

##### change unit cho and uric acid
xyplot(H~Cho, data=d,type=c("r", "p"))
cor(d$H,d$Cho, use="complete.obs")#0.28

xyplot(H~U, data=d,type=c("r", "p"))
cor(d$H,d$U, use="complete.obs")#0.19

d$H_B<-d$H+d$B
summary(d$H_B)
d$Cho_perVolBlood<-(d$Cho)/(1-d$H_B)
head(d)
xyplot(H~Cho_perVolBlood, data=d,type=c("r", "p"))
cor(d$H, d$Cho_perVolBlood, use="complete.obs")#0.53

d$U_perVolBlood<-(d$U)/(1-d$H_B)
xyplot(H~U_perVolBlood, data=d,type=c("r", "p"))
cor(d$H, d$U_perVolBlood, use="complete.obs")#0.28
cor(d$Cho_perVolBlood, d$U_perVolBlood, use="complete.obs")

#### standardize CORT for year of analysis
Cort2016<-subset(d, SY=="2016_2017",
                 select=c(BirdId, Cort))
Cort2016$CortStd<-(Cort2016$Cort-(mean(Cort2016$Cort,na.rm=T)))/(sd(Cort2016$Cort, na.rm=T))
summary(Cort2016$CortStd)
mean(Cort2016$CortStd, na.rm=T)
sd(Cort2016$CortStd, na.rm=T)
Cort2016<-na.omit(Cort2016)

Cort2017<-subset(d, SY=="2017_2018",
                 select=c(BirdId, Cort))
Cort2017$CortStd<-(Cort2017$Cort-(mean(Cort2017$Cort,na.rm=T)))/(sd(Cort2017$Cort, na.rm=T))
summary(Cort2017$CortStd)
mean(Cort2017$CortStd, na.rm=T)
sd(Cort2017$CortStd, na.rm=T)
Cort2017<-na.omit(Cort2017)

Cort2016_2018<-rbind(Cort2016, Cort2017)
Cort2016_2018<-subset(Cort2016_2018,
                      select=c(BirdId,CortStd))
d<-left_join(d, Cort2016_2018, by="BirdId") 

#### histogram voor supplements corticosterone ###
Cort2016$Year<-"2016-2017"
Cort2017$Year<-"2017-2018"
CortSuppl<-rbind(Cort2016, Cort2017)

mean(Cort2016$Cort)
sd(Cort2016$Cort)
min(Cort2016$Cort)
max(Cort2016$Cort)

mean(Cort2017$Cort)
sd(Cort2017$Cort)
min(Cort2017$Cort)
max(Cort2017$Cort)
mean <- c(4.2,10.8)
Year <- c("2016-2017", "2017-2018")
mu<-data.frame(mean, Year)
mu
```

```{r, include=F}
# select only relevant variables
f<-subset(d,
          select=c(LS,HS,CS, Age))
f<-na.omit(f) #n=762
summary(f)

## add histograms in ggplot
p1<-ggplot(f, aes(x=CS, fill=Age)) + 
  geom_histogram (color="black",binwidth=0.5, size=0.05)+
  geom_vline(aes(xintercept=mean(CS)),
             color="black", linetype="dashed", size=1)+
  labs(title="",x="Bill chroma", y = "Frequency")
p1

p2<-ggplot(f, aes(x=LS, fill=Age)) + 
  geom_histogram(color="black", binwidth=0.5, size=0.05)+
  geom_vline(aes(xintercept=mean(LS)),
             color="black", linetype="dashed", size=1)+
  labs(title="",x="Bill luminance", y = "")
p2

p3<-ggplot(f, aes(x=HS, fill=Age)) + 
  geom_histogram(color="black", binwidth=0.5, size=0.05)+
  geom_vline(aes(xintercept=mean(HS)),
             color="black", linetype="dashed", size=1)+
  labs(title="",x="Bill hue", y = "")
p3

################ plot colour for supplementary information#########################
min(f$CS) #41.4
max(f$CS) # 93.4
min(f$LS)# 29
max(f$LS) #78.6
min(f$HS) #47.3
max(f$HS) #79.2
mean(f$HS) #63.5

par(mfrow=c(2,3))
hclplot(sequential_hcl(5, h = 48, c = c(42,93), l = c(29,78), power = 1))
hclplot(sequential_hcl(5, h = 63, c = c(42,93), l = c(29,78), power = 1))
hclplot(sequential_hcl(5, h = 79, c = c(42,93), l = c(29,78), power = 1))

### combine all to one plot and export it
png("Fig.S7.png", width = 9000, height = 5000,units = 'px', res = 600)

par(mfrow=c(2,3))
ggarrange(p1,p2,p3,ncol=3, nrow=2)
hclplot(sequential_hcl(5, h = 48, c = c(42,93), l = c(29,78), power = 1), bg="white", lwd=0.5, size=2, cex=1)
hclplot(sequential_hcl(5, h = 63, c = c(42,93), l = c(29,78), power = 1), ylab="", bg="white", lwd=0.5, size=2, cex=1)
hclplot(sequential_hcl(5, h = 79, c = c(42,93), l = c(29,78), power = 1), ylab="", bg="white", lwd=0.5, size=2, cex=1)

ggarrange(p1,p2,p3,ncol=3, nrow=2)
hclplot(sequential_hcl(5, h = 48, c = c(42,93), l = c(29,78), power = 1), bg="white", lwd=0.5, size=2, cex=1)
hclplot(sequential_hcl(5, h = 63, c = c(42,93), l = c(29,78), power = 1), ylab="", bg="white", lwd=0.5, size=2, cex=1)
hclplot(sequential_hcl(5, h = 79, c = c(42,93), l = c(29,78), power = 1), ylab="", bg="white", lwd=0.5, size=2, cex=1)
grid.text("a)", x = unit(0.01, "npc"), y = unit(0.97, "npc"))
grid.text("b)", x = unit(0.34, "npc"), y = unit(0.97, "npc"))
grid.text("c)", x = unit(0.67, "npc"), y = unit(0.97, "npc"))
grid.text("d)", x = unit(0.01, "npc"), y = unit(0.48, "npc"))
grid.text("e)", x = unit(0.34, "npc"), y = unit(0.48, "npc"))
grid.text("f)", x = unit(0.67, "npc"), y = unit(0.48, "npc"))

dev.off()
```

Code S2: SEM for bill colour analysis (Figure 2a). The error variance of the variable HS (Hue) turns out to be slightly negative (close to 0) so that it is acceptable to fix the error variance of the variable HS to 0. The R-package used for the analysis is lavaan.
```{r warning=F}
f$AgeN<-ifelse(f$Age=="Adult",2,1)

lvmod.2 <-'
BCol=~LS+HS+CS  #define latent variable BCol=Bill colour
LS~~0*LS        #fix error variance of hue to 0
'
lvmod.2.fit<-cfa(lvmod.2,data=f, group="Age") #fit model
summary(lvmod.2.fit, rsq=T, standardized=T)  #model output
fitMeasures(lvmod.2.fit, c("chisq", "pvalue", "df","cfi", "srmr", "rmsea", "rmsea.ci.lower", "rmsea.ci.upper"))# model fit indices
```

```{r include=F}
### extract latent variable for bill colour for each age class
s2<-lavPredict(lvmod.2.fit)
s3<-data.frame(s2[[1]]) #only adults
s3SA<-data.frame(s2[[2]]) #only juv
```

Plot three bill colours per age class (Fig. S6)
```{r include=F}
g1<-ggplot(f, aes(x=LS,y=HS,color=Age))+
  geom_point()+xlab("Luminance")+ylab("Hue")+theme(legend.position="top")+
    theme(legend.text=element_text(size=13),
  legend.title=element_text(size=14),
  axis.text=element_text(size=13),
  axis.title=element_text(size=14))
       
g2<-ggplot(f, aes(x=LS,y=CS,color=Age))+
  geom_point()+xlab("Luminance")+ylab("Chroma")+theme(legend.position="top")+
    theme(legend.text=element_text(size=13),
  legend.title=element_text(size=14),
  axis.text=element_text(size=13),
  axis.title=element_text(size=14))

g3<-ggplot(f, aes(x=HS,y=CS,color=Age))+
  geom_point()+xlab("Hue")+ylab("Chroma")+theme(legend.position="top")+
  theme(legend.text=element_text(size=13),
  legend.title=element_text(size=14),
  axis.text=element_text(size=13),
  axis.title=element_text(size=14))

### combine all to one plot and export!
png("Fig.S6.png", width = 9000, height = 3000,units = 'px', res = 600)

par(mfrow=c(1,3))
ggarrange(g1,g2,g3,ncol=3, nrow=1)
grid.text("a)", x = unit(0.01, "npc"), y = unit(0.97, "npc"))
grid.text("b)", x = unit(0.34, "npc"), y = unit(0.97, "npc"))
grid.text("c)", x = unit(0.67, "npc"), y = unit(0.97, "npc"))
dev.off()
```

Create a PCA of bill colour 
```{r include=F}
########## select only adults ##################
summary(f)
fA<-subset(f,Age=="Adult")

##PCA bill adults
par(mfrow=c(1,1))
PCA_Bill_Ad<-data.frame(fA$HS,fA$LS,fA$CS)

colnames(PCA_Bill_Ad) <- c("Hue", "Luminance", "Chroma")

res.pca_Ad<-PCA(PCA_Bill_Ad, scale.unit = TRUE, ncp = 5, graph = TRUE)
res.pca_Ad_eig<- get_eigenvalue(res.pca_Ad)
res.pca_Ad_eig ### for interpretation 

res.pca_Ad$var$cor

fviz_pca_var(res.pca_Ad, col.var = "black", repel=T, labelsize=4)+
  theme(
    axis.title = element_text(size = 10),
    axis.text = element_text(size = 8))+
  labs(title="Adult bill colour", x="PC1 (88.8%)", y="PC2 (9.9%)")

########## select only sub-adults ##################
summary(f$Age)
fSA<-subset(f,Age=="Sub-Adult")

##PCA bill sub-adults
par(mfrow=c(1,1))
PCA_Bill_SA<-data.frame(fSA$HS,fSA$LS,fSA$CS)

colnames(PCA_Bill_SA) <- c("Hue", "Luminance", "Chroma")

res.pca_SA<-PCA(PCA_Bill_SA, scale.unit = TRUE, ncp = 5, graph = TRUE)
res.pca_SA_eig <- get_eigenvalue(res.pca_SA)
res.pca_SA_eig

res.pca_SA$var$cor

fviz_pca_var(res.pca_SA, col.var = "black", repel=T, labelsize=4)+
  theme(
    axis.title = element_text(size = 10),
    axis.text = element_text(size = 8))+
  labs(title="Sub-adult bill colour", x="PC1 (69.4%)", y="PC2 (30.3%)")

```

Check correlation PCA and CFA (bill colour)
```{r include=F}
## check correlation between PC1 and latent variable bill colour
# adults
axes_Bill_Ad<-res.pca_Ad$ind
axes_Bill_Ad1<-data.frame(axes_Bill_Ad$coord) #extract hiervan coord.Dim.1 (PC1)
corBill_Ad <- cbind(s3, axes_Bill_Ad1) #add pca1 to dataset
corBill_Ad$PC1_Bill<-corBill_Ad$Dim.1
cor(corBill_Ad$BCol, corBill_Ad$PC1_Bill)
plot(corBill_Ad$BCol, corBill_Ad$PC1_Bill)
FigS8b<-ggplot(corBill_Ad, aes(x=BCol, y=PC1_Bill)) +
  geom_point(size=1.5)+
  labs(x = "CFA", y="PCA")+
  ggtitle("Correlation of adult bill colour")
FigS8b

#sub-adults
axes_Bill_SA<-res.pca_SA$ind
axes_Bill_SA1<-data.frame(axes_Bill_SA$coord) #extract hiervan coord.Dim.1 (PC1)
corBill_SA1 <- cbind(s3SA, axes_Bill_SA1) #add pca1 to dataset
corBill_SA1$PC1_Bill<-corBill_SA1$Dim.1
cor(corBill_SA1$BCol, corBill_SA1$PC1_Bill)
plot(corBill_SA1$BCol, corBill_SA1$PC1_Bill)
FigS8c<-ggplot(corBill_SA1, aes(x=BCol, y=PC1_Bill)) +
  geom_point(size=1.5)+
  labs(x = "CFA", y="PCA")+
  ggtitle("Correlation of sub-adult bill colour")
FigS8c
```

Plot supplement Fig. S8
```{r include=F}
#### combine fig 4a,b,c
png("Fig.S8.png", width = 7300, height = 3000,units = 'px', res = 600)
(FigS8a| FigS8b | FigS8c)
grid.text("a)", x = unit(0.03, "npc"), y = unit(0.96, "npc"))
grid.text("b)", x = unit(0.36, "npc"), y = unit(0.96, "npc")) #export as 1500x1000
grid.text("c)", x = unit(0.69, "npc"), y = unit(0.96, "npc"))
dev.off()
```

Table S5
```{r echo=F}
LoadingsBillAd<-res.pca_Ad$var$coord
kable(LoadingsBillAd,digits=2, format="pandoc", caption="Table S5: Loadings from the PC1, PC2 and PC3 of the adult bill colour. PCA analyses were conducted with the R-package FactoMineR.")
```

Table S6
```{r echo=F}
LoadingsBillSA<-res.pca_SA$var$coord
kable(LoadingsBillSA,digits=2, format="pandoc", caption="Table S6: Loadings from the PC1, PC2 and PC3 of the sub-adult bill colour. PCA analyses were conducted with the R-package FactoMineR.")
```

Fig. S4
```{r echo = FALSE,fig.width=4,fig.height=4, fig.cap="\\label{fig:figs}Figure S4: Adult bill colour PCA. Note that the luminance and hue arrows lie almost above each other. PCA visualization was conducted with the R-package factoextra"}
fviz_pca_var(res.pca_Ad, col.var = "black", repel=T, labelsize=4)+
  theme(
    axis.title = element_text(size = 10),
    axis.text = element_text(size = 8))+
  labs(title="Adult bill colour", x="PC1 (88.8%)", y="PC2 (9.9%)")
```

Fig. S5
```{r echo = FALSE,fig.width=4,fig.height=4, fig.cap="\\label{fig:figs}Figure S5: Sub-adult bill colour PCA. Note that the luminance and hue arrows lie almost above each other. PCA visualization was conducted with the R-package factoextra"}
fviz_pca_var(res.pca_SA, col.var = "black", repel=T, labelsize=4)+
  theme(
    axis.title = element_text(size = 10),
    axis.text = element_text(size = 8))+
  labs(title="Sub-adult bill colour", x="PC1 (69.4%)", y="PC2 (30.3%)")
```

#################################################################################################################################
############## section 2: composite variable ####################################################################################
#################################################################################################################################

Prepare data for analysis
```{r include=F}
#standardized variables
d$nTA<-(d$TA-mean(d$TA, na.rm=T))/(sd(d$TA, na.rm=T))
d$nWL<-(d$WL-mean(d$WL, na.rm=T))/(sd(d$WL, na.rm=T))
d$nHT<-(d$HT-mean(d$HT, na.rm=T))/(sd(d$HT, na.rm=T))
d$nTH<-(d$TH-mean(d$TH, na.rm=T))/(sd(d$TH, na.rm=T))
d$nBH<-(d$BH-mean(d$BH, na.rm=T))/(sd(d$BH, na.rm=T))

p<-ggplot(d, aes(x=BH)) + 
  geom_histogram(color="black", fill="white", binwidth=0.5)+
  geom_vline(aes(xintercept=mean(BH)),
             color="blue", linetype="dashed", size=1)+
  labs(title="",x="Bill tip height (mm)", y = "Count")
p

d$AgeN<-ifelse(d$AgeN==2,1,2)

### select only relevant variables
d1<-subset(d,
           select=c(U_perVolBlood,MS,Cho_perVolBlood,CortStd,LogitB,LogitH,LogitSurvWS, nTA,Density, CL, SY, TA, SurvWS, AgeN, TH, WL))
d1<-na.omit(d1) #n=447

#ratio
d1$ratio<-d1$MS/d1$TA

#residuals
m2<-lm(MS~TA+WL+TH, data=d1)
d1$Residuals<-resid(m2)
```

Code S3: Code for the composite variable model (Figure 5). Note that in this example the model fit index (CFI) indicates poor fit. However, remember that this simply serves as a simple illustration for running a composite variable in SEM and is not yet biologically correct e.g. missing confounding variables. The first variable (determining the composite variable) should always be multiplied by 1 to set the scale (for other variables). We multiplied the first variable "ratio" by -1 because it has a negative effect on the condition. If we multiply it by 1 we get a negative effect of condition on survival wich makes interpretation more difficult. All absolute values of the coefficients stay the same (when multiplyinh by 1 or -1). The R-package used for the analysis is lavaan.
```{r warning=F}
# Variable scaling
d1$MSK<-d1$MS/1000
d1$Dens<-d1$Density/1000
d1$TA100<-d1$TA/100
d1$TH100<-d1$TH/100
d1$WL100<-d1$WL/100
d1$Cho10<-d1$Cho_perVolBlood/10

Cmod.1 <- '
Comp <~ -1*lMS+CortStd+U_perVolBlood+Cho10+LogitH+LogitB  # define the composite variable
lMS =~ MSK                                                # create latent variable of mass
lMS~WL100+TA100+TH100                                     # regress structural sizes on latent mass
LogitSurvWS~Comp                                          # regress the composite on survival
Comp~Dens                                                 # regress the denisty on the composite variable
' 
Cmod.1.fit<-sem(Cmod.1,data=d1) # fit the model
summary(Cmod.1.fit, rsq=T, standardized=T)# get the output of the sem 
fitMeasures(Cmod.1.fit, c("chisq", "pvalue", "df","cfi", "srmr", "rmsea", "rmsea.ci.lower", "rmsea.ci.upper")) #get the model fit indices
```

Code S4: Model with squared mass
```{r warning=F}
# squared mass
d1$ResidualsSc<-d1$Residuals/100
d1$ResidualsSc2<-d1$ResidualsSc*d1$ResidualsSc
d1$Cho10<-d1$Cho_perVolBlood/10 #scaled cholesterol

Cmod.2 <- '
Comp <~ -1*ResidualsSc+ResidualsSc2+CortStd+U_perVolBlood+Cho10+LogitH+LogitB # define the composite variable
LogitSurvWS~Comp                                        #regress the composite on survival
Comp~Dens                                               #regress the denisty on the composite variable
ResidualsSc~~ResidualsSc2
' 
Cmod.2.fit<-sem(Cmod.2,data=d1, fixed.x=F) # fit the model
summary(Cmod.2.fit, rsq=T, standardized=T)# get the output of the sem 
varTable(Cmod.2.fit)
```


```{r include=F}
## extract predicted values from composite model
s<-lavPredict(Cmod.1.fit)
s1<-data.frame(s)
k<-cbind(d1, s1)

########################################### plot figure (Fig. 4b) ##################################################

#standardize condition
k$nComp<-(k$Comp-mean(k$Comp, na.rm=T))/(sd(k$Comp, na.rm=T))

l<-seq(from = 13,
       to = 260, by = 3.1)
m1a<-lm(nComp~Density, data=k)
predict(m1a)
xyplot(nComp~Density, data=k, type=c("r", "p"))
summary(m1a)

k$CL1<-factor(k$CL,levels=c("Ameland","Balgzand&Texel", "Oosterschelde", "Rottum&kust", "Schiermonnikoog", "Vlieland"),
              labels=c("T","B","D", "R", "S", "V"))

r<- seq(from = -2.6,
        to = 2.6, by = 0.0655)

## adjust range
MyDataCond <- data.frame(nComp=seq(from = -2.6,
                                   to = 2.6, by = 0.0655),
                         Density=seq(from = 13,
                                        to = 260, by = 3.1))
P1 <- predict(m1a, newdata = MyDataCond, se=T)
summary(P1)
MyDataCond$Pred<-P1$fit
MyDataCond$UpperPred<-(P1$fit+1.96*P1$se.fit)
MyDataCond$LowerPred<-(P1$fit-1.96*P1$se.fit)

summary(MyDataCond)
p1<-ggplot(MyDataCond,aes(y =nComp , x =Density))+
  geom_point(data=k, mapping=aes(y=nComp, x=Density), size=2)+
  geom_line(data=MyDataCond,mapping=aes(y=Pred,x=Density), size=1.1)+
  geom_line(data=MyDataCond,mapping=aes(y=UpperPred,x=Density),linetype="dashed",size=1.1)+
  geom_line(data=MyDataCond,mapping=aes(y=LowerPred,x=Density), linetype="dashed",size=1.1)+
  ylab("Condition index (standardized)") + xlab("Oystercatcher density (number/km2)")+
  theme(text = element_text(size=18))

p1
```

Fig. S9 and Fig. S10
```{r include=F}
# Fig. S9
l<-seq(from = -2.6,
       to = 2.6, by = 0.114)
r<-seq(from = 1.09,
       to = 3.1, by = 0.044)
p<-seq(seq(from=0.73, to=0.96, by=0.0051))

m1a<-lm(LogitSurvWS~nComp, data=k)
predict(m1a)
xyplot(LogitSurvWS~nComp, data=k, type=c("r", "p"))

MyDataCond <- data.frame(nComp=seq(from = -2.6,
       to = 2.6, by = 0.114),
                         survProb=seq(from=0.73, to=0.96, by=0.0051),
                         LogitSurvWS=seq(from = 1.09,
       to = 3.1, by = 0.044))
P2 <- predict(m1a, newdata = MyDataCond, se=T)

MyDataCond$Pred<-exp(P2$fit) / (1+exp(P2$fit))
MyDataCond$UpperPred<-exp(P2$fit+1.96*P2$se.fit) /(1 + exp(P2$fit + 1.96 * P2$se.fit))
MyDataCond$LowerPred<-exp(P2$fit-1.96*P2$se.fit) /(1 + exp(P2$fit - 1.96 * P2$se.fit))

pSurv<-ggplot(MyDataCond,aes(x =nComp , y =survProb))+
  geom_point(data=k, mapping=aes(x=nComp, y=SurvWS), size=2)+
  geom_line(data=MyDataCond,mapping=aes(x=nComp,y=Pred), size=1.1)+
  geom_line(data=MyDataCond,mapping=aes(x=nComp,y=UpperPred),linetype="dashed",size=1.1)+
  geom_line(data=MyDataCond,mapping=aes(x=nComp,y=LowerPred), linetype="dashed",size=1.1)+
  ylab("Survival probability") + xlab("Condition index (standardized)")+
  theme(text = element_text(size=18))
pSurv

### Fig. S10
l<-seq(from = 13,
       to = 260, by = 6.4)
r<-seq(from = 1.09,
       to = 3.1, by = 0.052)
p<-seq(seq(from=0.73, to=0.96, by=0.006))

m1a<-lm(LogitSurvWS~Density, data=k)
predict(m1a)
xyplot(LogitSurvWS~Density, data=k, type=c("r", "p"))

MyDataCond <- data.frame(Density=seq(from = 13,
       to = 260, by = 6.4),
                         survProb=seq(from=0.73, to=0.96, by=0.006),
                         LogitSurvWS=seq(from = 1.09,
       to = 3.1, by = 0.052))
P3 <- predict(m1a, newdata = MyDataCond, se=T)

MyDataCond$Pred<-exp(P3$fit) / (1+exp(P3$fit))
MyDataCond$UpperPred<-exp(P3$fit+1.96*P3$se.fit) /(1 + exp(P3$fit + 1.96 * P3$se.fit))
MyDataCond$LowerPred<-exp(P3$fit-1.96*P3$se.fit) /(1 + exp(P3$fit - 1.96 * P3$se.fit))

pDens<-ggplot(MyDataCond,aes(x =Density , y =survProb))+
  xlim(0,260)+
  geom_point(data=k, mapping=aes(x=Density, y=SurvWS), size=2)+
  geom_line(data=MyDataCond,mapping=aes(x=Density,y=Pred), size=1.1)+
  geom_line(data=MyDataCond,mapping=aes(x=Density,y=UpperPred),linetype="dashed",size=1.1)+
  geom_line(data=MyDataCond,mapping=aes(x=Density,y=LowerPred), linetype="dashed",size=1.1)+
  ylab("Survival probability") + xlab("Oystercatcher density (number/km2)")+
  theme(text = element_text(size=18))
pDens
```

```{r, echo = FALSE, fig.width=13,fig.height=6,fig.cap="\\label{fig:figs}Figure S9: Relationship between the standardized condition and the survival probablity"}
pSurv
```

```{r, echo = FALSE, fig.width=13,fig.height=6,fig.cap="\\label{fig:figs}Figure S10: The effect of density on survival probablity"}
pDens
```

################################################################################################################################
################################################# Section 3 ####################################################################
################################################################################################################################

Select relevant variables for the analysis
```{r include=F}
f<-subset(d,
          select=c(BirdId,LS,CS, HS, SexN, AgeN,TA,HT,Cort,SurvWS,Cho_perVolBlood,U_perVolBlood,LogitH,LogitB,
                   BH,MS,Age,TH,WL,
                   LogitSurvWS, CL, SY, Density))
f<-na.omit(f) #n=427

#standardized variables
f$nHT<-(f$HT-mean(f$HT, na.rm=T))/(sd(f$HT, na.rm=T))
f$nWL<-(f$WL-mean(f$WL, na.rm=T))/(sd(f$WL, na.rm=T))
f$nTA<-(f$TA-mean(f$TA, na.rm=T))/(sd(f$TA, na.rm=T))
f$nBH<-(f$BH-mean(f$BH, na.rm=T))/(sd(f$BH, na.rm=T))
f$nTH<-(f$TH-mean(f$TH, na.rm=T))/(sd(f$TH, na.rm=T))

#calculate ratios/residuals for latent energy store
f$ratio<-f$MS/f$TA

#### standardize CORT for year of analysis
Cort2016<-subset(f, SY=="2016_2017",
                 select=c(BirdId, Cort))
Cort2016$CortStd<-(Cort2016$Cort-(mean(Cort2016$Cort,na.rm=T)))/(sd(Cort2016$Cort, na.rm=T))
summary(Cort2016$CortStd)
mean(Cort2016$CortStd, na.rm=T)
sd(Cort2016$CortStd, na.rm=T)
Cort2016<-na.omit(Cort2016)

Cort2017<-subset(f, SY=="2017_2018",
                 select=c(BirdId, Cort))
Cort2017$CortStd<-(Cort2017$Cort-(mean(Cort2017$Cort,na.rm=T)))/(sd(Cort2017$Cort, na.rm=T))
summary(Cort2017$CortStd)
mean(Cort2017$CortStd, na.rm=T)
sd(Cort2017$CortStd, na.rm=T)
Cort2017<-na.omit(Cort2017)

Cort2016_2018<-rbind(Cort2016, Cort2017)
Cort2016_2018<-subset(Cort2016_2018,
                      select=c(BirdId,CortStd))
f<-left_join(f, Cort2016_2018, by="BirdId") 

#ratio
f$ratio<-f$MS/f$TA

#residuals
m2<-lm(MS~TA+WL+TH, data=f)
summary(m2)
f$Residuals<-resid(m2)
```


```{r include=F}
#Scaling variables:
f$CortStd10<-f$CortStd/10
f$nBH10<-f$nBH/10
f$MSK<-f$MS/1000
f$LS<-f$LS/100
f$CS<-f$CS/100
f$HS<-f$HS/100
f$Density<-f$Density/100
f$TA<-f$TA/100
f$TH<-f$TH/100
f$WL<-f$WL/100
f$Cho_perVolBlood<-f$Cho_perVolBlood/10
f$nHT10<-f$nHT/10
```

Code S5: R-code of the final model including latent variables (bill colour and energy store) and a composite variable (body condition). See Code S4 for explanation of the -1 infront of CortStd (composite variable). Covariance structure was defined in the model because it is expected that the error term handling time and squared handling time are correlated. Similarly we expect the error term of haematocrit and cholesterol to be correlate because cholesterol is determined in mmol/l blood which means that is is related to the proportion of haematocrit in the blood. The R-package used for the analysis is lavaan.
```{r warning=F}
Cmod.3 <- '
#Bill colour
BCol =~ HS

#Energy store
ES =~ lMS+ratio         
lMS =~ MSK
lMS ~ TA + TH +WL       
lMS~~0*lMS

#cond variables: regress confounding and individual variables on the different condition measures
lCho =~ Cho_perVolBlood
lH =~ LogitH 
lB =~ LogitB
lU =~ U_perVolBlood
lCort =~ CortStd10
lB + lH + lCho + ES + lU ~ AgeN+SexN+nBH10+nHT10 
lCort + BCol ~ AgeN+SexN+nBH10

#composite
Comp <~ -1*ES+lCort+BCol+lH+lB+lCho+lU   #define the composite variable with the condition variables
LogitSurvWS ~ Comp  
Comp ~ Density   

#add covariance structure
lCho~~lH
lU~~lH 
'

Cmod.3.fit<-sem(Cmod.3,data=f) #fit the model
summary(Cmod.3.fit, rsq=T, standardized=T) #get model output
fitMeasures(Cmod.3.fit, c("chisq", "pvalue", "df","cfi", "srmr", "rmsea", "rmsea.ci.lower", "rmsea.ci.upper")) #get model fit indices
```

Code S6: The full model (Fig. 5) with only one size structure (tarsus length) and an added 
direct effect of body size on survival. For model results in a figure see Fig. S13. The R-package used for the analysis is lavaan. 

```{r warning=F}
Cmod.4 <- '
BCol =~ HS

ES =~ MSK+ratio  
MSK ~ TA
MSK~~0*MSK

#cond variables: regress confounding and individual variables on the different condition measures
lCho =~ Cho_perVolBlood
lH =~ LogitH 
lB =~ LogitB
lU =~ U_perVolBlood
lCort =~ CortStd10
lB + lH + lCho + ES + lU ~ AgeN+SexN+nBH10+nHT10
lCort + BCol ~ AgeN+SexN+nBH10

#composite
Comp <~ -1*ES+lCort+BCol+lH+lB+lCho+lU  
LogitSurvWS ~ Comp + TA 
Comp~ Density     

#add covariance structure
lCho~~lH
lU~~lH 
'
Cmod.4.fit<-sem(Cmod.4,data=f)
summary(Cmod.4.fit, standardized=T, rsq=T)
fitMeasures(Cmod.4.fit, 
            c("chisq", "pvalue", "df","cfi", "nfi","srmr", "rmsea", "rmsea.ci.lower", 
              "rmsea.ci.upper", "AIC", "rmsea.pvalue")) 
```

Code S7: The full model (Fig. 5) with only one size structure (tarsus length) and only an 
indirect effect of body size on survival. For model results in a figure see Fig. S13. The R-package used for the analysis is lavaan. 
```{r warning=F}
Cmod.5 <- '
BCol =~ HS

ES =~ MSK+ratio         
MSK ~ TA
MSK~~0*MSK

#cond variables: regress confounding and individual variables on the different condition measures
lCho =~ Cho_perVolBlood
lH =~ LogitH 
lB =~ LogitB
lU =~ U_perVolBlood
lCort =~ CortStd10
lB + lH + lCho + ES + lU ~ AgeN+SexN+nBH10+nHT10 #+nDS
lCort + BCol ~ AgeN+SexN+nBH10

#composite
Comp <~ -1*ES+lCort+BCol+lH+lB+lCho+lU  #lCho+lB+lH+ #define the composite variable with the condition variables
LogitSurvWS ~ Comp  
Comp~ Density       

#add covariance structure
lCho~~lH
lU~~lH 
'
Cmod.5.fit<-sem(Cmod.5,data=f)
summary(Cmod.5.fit, standardized=T, rsq=T)
fitMeasures(Cmod.5.fit, 
            c("chisq", "pvalue", "df","cfi", "nfi","srmr", "rmsea", "rmsea.ci.lower", 
              "rmsea.ci.upper", "AIC", "rmsea.pvalue"))
```


Table S8: Comparison of the two full models (Fig. S13). Cmod.5.fit  indicating the model without a direct effect of body size, Cmod.4.fit indicating the model with a direct effect of body size on survival.
```{r echo=F}
anova(Cmod.5.fit,Cmod.4.fit)
```

Code S8: SEM Model for comparing performance (without competitior density in the model)
```{r}
lvmod.6  <- '
#Bill colour
BCol =~ HS

#Energy store
ES =~ lMS+ratio         
lMS =~ MSK
lMS ~ TA + TH +WL     
lMS~~0*lMS

#cond variables: regress confounding and individual variables on the different condition measures
lCho =~ Cho_perVolBlood
lH =~ LogitH 
lB =~ LogitB
lU =~ U_perVolBlood
lCort =~ CortStd10
lB + lH + lCho + ES + lU ~ AgeN+SexN+nBH10+nHT10 
lCort + BCol ~ AgeN+SexN+nBH10

#composite
Comp <~ -1*ES+lCort+BCol+lH+lB+lCho+lU  #lCho+lB+lH+ #define the composite variable with the condition variables
LogitSurvWS ~ Comp  
#Comp ~ Density   

#add covariance structure
lCho~~lH
lU~~lH 
'
lvmod.6.fit<-sem(lvmod.6,data=f) #fit the model
summary(lvmod.6.fit, rsq=T, standardized=T) #get model output
fitMeasures(lvmod.6.fit, c("chisq", "pvalue", "df","cfi", "srmr", "rmsea", "rmsea.ci.lower", "rmsea.ci.upper")) #get model fit indices
```

Predictions SEM
```{r include=F}
s1<-lavPredict(lvmod.6.fit, type="lv")
s1<-data.frame(s1)
s<-cbind(s1,f)
```

Conventional approach (Fig. 6b)
```{r include=F}
#Step 1 (Fig. 6b): MR
df<-s
MSPCA <- lm(MSK~TA+TH+WL, data=df)
df$residMSPCA<-resid(MSPCA) # extract residuals from the mass model

mCort<-lm(CortStd10~SexN+nBH10+AgeN, data=df) 
df$residCort<-resid(mCort) #residuals corticosterone

mCho<-lm(Cho_perVolBlood~SexN+nBH10+nHT10+AgeN, data=df)
df$residCho<-resid(mCho) ##residuals cholesterol

mU<-lm(U_perVolBlood~SexN+nBH10+nHT10+AgeN, data=df)
df$residU<-resid(mU) #residuals uric acid

mH<-lm(LogitH~SexN+nBH10+nHT10+AgeN, data=df)
df$residH<-resid(mH) #residuals haematocirt

mB<-lm(LogitB~SexN+nBH10+nHT10+AgeN, data=df)
df$residB<-resid(mB) #residuals buffy coat

Bill<-lm(HS~SexN+nBH10+AgeN, data=df)
df$residBill<-resid(Bill) ##residuals bill colour

#Step 2 (Fig. 6b): PCA
##PCA energy stores from residuals and ratio
par(mfrow=c(1,1))
PCA_Fat<-data.frame(df$ratio, df$residMSPCA)

colnames(PCA_Fat) <- c("Ratio", "Residuals")

res.pca<-PCA(PCA_Fat, scale.unit = TRUE, ncp = 5, graph = TRUE)
axes_Fat_1<-res.pca$ind
axes_Fat<-data.frame(axes_Fat_1$coord) #extract PC1

df <- cbind(df, axes_Fat) #add pc1 to dataset
str(df)
df$PC1_Fat<-df$Dim.1 # rename dim1=pc1 to PC1_Fat

#Step 3 (Fig. 6b): MR
Fat<-lm(PC1_Fat~SexN+nBH10+AgeN+nHT10, data=df)
df$residFat<-resid(Fat)

#Step 4 (Fig. 6b): MR
mSurv<-lm(LogitSurvWS~residFat+residBill+residCort+residCho+residU+residH+residB, data=df)
```

Code S9: R-code and output of the cross validation for the SEM approach (Figue 6a) and the conventional (regression & PCA) approach (Figure 6b) conducted with the R-package caret. 
```{r include=F}
####################### SEM ################################
set.seed(121)
train.control <- trainControl(method = "repeatedcv", 
                              number = 10, repeats = 3, p=.8)
# Train the model
SEMmodel <- train(LogitSurvWS~Comp, data = s, method = "lm",
                  trControl = train.control)
# Summarize the results
print(SEMmodel) #0.3293091  which measures the average prediction error made by the model in predicting the outcome for an 
#observation. That is, the average difference between the observed known outcome values and the values
#predicted by the model. The lower the RMSE, the better the model.
#  RMSE       Rsquared   MAE      
#  0.4383024  0.1769444  0.3340294


####################### conventional ################################
df$predict<-predict(mSurv) #get predicted values of final conventional model (from step 4, Fig. 6b)

# Train the model
set.seed(125)
train.control <- trainControl(method = "repeatedcv", 
                              number = 10, repeats = 3, p=.8)
PCAmodel <- train(LogitSurvWS~predict, data = df, method = "lm",
                  trControl = train.control)
# Summarize the results
print(PCAmodel)
#  RMSE       Rsquared   MAE      
#  0.4420557  0.1625398  0.3323978
```

Supplements: Plot raw data mass on survival (Fig. S12)
```{r include=F}
mMS<-lm(MS~TA+TH+WL, data=f)
f$residmMS<-resid(mMS)
summary(mMS)
mSurvMS<-lm(LogitSurvWS~residmMS, data=f)
summary(mSurvMS)

par(mfrow=c(2,1))

pM1<-ggplot(f, aes(x = residmMS, y = SurvWS)) + 
  geom_point() +
  stat_smooth(method = "lm", col = "red")+
  xlab("Residuals of mass: mass corrected for size \n(tarsus length, head length and wing length)")+
  ylab("Survival probability")

pM2<-ggplot(f, aes(x = MS, y = SurvWS)) + 
  geom_point() +
  stat_smooth(method = "lm", col = "red")+
  xlab("Mass (gr)")+
  ylab("Survival probability")

df.meanYearArea <- 
  f %>%
  dplyr::group_by(SY, CL, Age) %>%
  dplyr::summarize(mean(residmMS), sd(residmMS), mean(SurvWS))
df.meanYearArea<-data.frame(df.meanYearArea) #, CL, Age
#add regression statistics in supplements + add raw data in background
df.meanYearArea$upper<-df.meanYearArea$mean.residmMS.+ df.meanYearArea$sd.residmMS.
df.meanYearArea$lower<-df.meanYearArea$mean.residmMS.- df.meanYearArea$sd.residmMS.

pM3<-ggplot()+#data=f, aes(x=residmMS, y=SurvWS)) + 
  geom_point(data=f, mapping=aes(x=residmMS, y=SurvWS, shape=Age, color=Age),alpha=.3, size=2.5) +#shape=Age, color=Age
  #stat_smooth(data=f, mapping=aes(x=residmMS, y=SurvWS),method = "lm", col = "#999999")+
  geom_point(data=df.meanYearArea, mapping=aes(x=mean.residmMS., y=mean.SurvWS., shape=Age, color=Age), size=3.5)+#shape=Age, color=Age
  geom_errorbarh(data=df.meanYearArea, aes(y=mean.SurvWS.,xmax=upper, xmin=lower, color=Age))+#shape=Age, color=Age
  scale_color_manual(values=c("#E69F00", "#56B4E9"))+
  xlab("Residuals of mass: mass corrected for size \n(tarsus length, head length and wing length)")+
  ylab("Survival probability")

pM4<-ggplot()+ theme_void()

png("Fig. S12.png", width = 7300, height = 4373,units = 'px', res = 600)
(pM1/pM2|pM3/plot_spacer())+
plot_annotation(tag_levels = 'a')
dev.off()
```

Table S7
```{r include=F}
# summarize model fits
# latent model: energy stores (Fig. 2a)
mod1_cq<-fitMeasures(lvmod.1.fit, c("chisq")) 
mod1_p<-fitMeasures(lvmod.1.fit, c("pvalue")) 
mod1_df<-fitMeasures(lvmod.1.fit, c("df")) 
mod1_cfi<-fitMeasures(lvmod.1.fit, c("cfi")) 
mod1_srmr<-fitMeasures(lvmod.1.fit, c("srmr")) 
mod1_rmsea<-fitMeasures(lvmod.1.fit, c("rmsea")) 
mod1_rmseaLC<-fitMeasures(lvmod.1.fit, c("rmsea.ci.lower")) 
mod1_rmseaUP<-fitMeasures(lvmod.1.fit, c("rmsea.ci.upper")) 

# latent model: bill colour (Fig. 2b)
mod2_cq<-fitMeasures(lvmod.2.fit, c("chisq")) 
mod2_p<-fitMeasures(lvmod.2.fit, c("pvalue")) 
mod2_df<-fitMeasures(lvmod.2.fit, c("df")) 
mod2_cfi<-fitMeasures(lvmod.2.fit, c("cfi")) 
mod2_srmr<-fitMeasures(lvmod.2.fit, c("srmr")) 
mod2_rmsea<-fitMeasures(lvmod.2.fit, c("rmsea")) 
mod2_rmseaLC<-fitMeasures(lvmod.2.fit, c("rmsea.ci.lower")) 
mod2_rmseaUP<-fitMeasures(lvmod.2.fit, c("rmsea.ci.upper")) 

# composite model (Fig. 4)
mod3_cq<-fitMeasures(Cmod.1.fit, c("chisq")) 
mod3_p<-fitMeasures(Cmod.1.fit, c("pvalue")) 
mod3_df<-fitMeasures(Cmod.1.fit, c("df")) 
mod3_cfi<-fitMeasures(Cmod.1.fit, c("cfi")) 
mod3_srmr<-fitMeasures(Cmod.1.fit, c("srmr")) 
mod3_rmsea<-fitMeasures(Cmod.1.fit, c("rmsea")) 
mod3_rmseaLC<-fitMeasures(Cmod.1.fit, c("rmsea.ci.lower")) 
mod3_rmseaUP<-fitMeasures(Cmod.1.fit, c("rmsea.ci.upper")) 

#composite model + squared mass
mod4_cq<-fitMeasures(Cmod.2.fit, c("chisq")) 
mod4_p<-fitMeasures(Cmod.2.fit, c("pvalue")) 
mod4_df<-fitMeasures(Cmod.2.fit, c("df")) 
mod4_cfi<-fitMeasures(Cmod.2.fit, c("cfi")) 
mod4_srmr<-fitMeasures(Cmod.2.fit, c("srmr")) 
mod4_rmsea<-fitMeasures(Cmod.2.fit, c("rmsea")) 
mod4_rmseaLC<-fitMeasures(Cmod.2.fit, c("rmsea.ci.lower")) 
mod4_rmseaUP<-fitMeasures(Cmod.2.fit, c("rmsea.ci.upper")) 

# Composite model + latent model = full model (Fig. 5)
mod5_cq<-fitMeasures(Cmod.3.fit, c("chisq")) 
mod5_p<-fitMeasures(Cmod.3.fit, c("pvalue")) 
mod5_df<-fitMeasures(Cmod.3.fit, c("df")) 
mod5_cfi<-fitMeasures(Cmod.3.fit, c("cfi")) 
mod5_srmr<-fitMeasures(Cmod.3.fit, c("srmr")) 
mod5_rmsea<-fitMeasures(Cmod.3.fit, c("rmsea")) 
mod5_rmseaLC<-fitMeasures(Cmod.3.fit, c("rmsea.ci.lower")) 
mod5_rmseaUP<-fitMeasures(Cmod.3.fit, c("rmsea.ci.upper")) 

# Composite model with direct effect of body size (tarsus length) (Fig. S13a)
mod6_cq<-fitMeasures(Cmod.4.fit, c("chisq")) 
mod6_p<-fitMeasures(Cmod.4.fit, c("pvalue")) 
mod6_df<-fitMeasures(Cmod.4.fit, c("df")) 
mod6_cfi<-fitMeasures(Cmod.4.fit, c("cfi")) 
mod6_srmr<-fitMeasures(Cmod.4.fit, c("srmr")) 
mod6_rmsea<-fitMeasures(Cmod.4.fit, c("rmsea")) 
mod6_rmseaLC<-fitMeasures(Cmod.4.fit, c("rmsea.ci.lower")) 
mod6_rmseaUP<-fitMeasures(Cmod.4.fit, c("rmsea.ci.upper")) 

# Composite model with indirect effect of body size (tarsus length) (Fig. S13b)
mod7_cq<-fitMeasures(Cmod.5.fit, c("chisq")) 
mod7_p<-fitMeasures(Cmod.5.fit, c("pvalue")) 
mod7_df<-fitMeasures(Cmod.5.fit, c("df")) 
mod7_cfi<-fitMeasures(Cmod.5.fit, c("cfi")) 
mod7_srmr<-fitMeasures(Cmod.5.fit, c("srmr")) 
mod7_rmsea<-fitMeasures(Cmod.5.fit, c("rmsea")) 
mod7_rmseaLC<-fitMeasures(Cmod.5.fit, c("rmsea.ci.lower")) 
mod7_rmseaUP<-fitMeasures(Cmod.5.fit, c("rmsea.ci.upper")) 

# Model used for model performance (without competitor density) (Fig. 6a)
mod8_cq<-fitMeasures(lvmod.6.fit, c("chisq")) 
mod8_p<-fitMeasures(lvmod.6.fit, c("pvalue")) 
mod8_df<-fitMeasures(lvmod.6.fit, c("df")) 
mod8_cfi<-fitMeasures(lvmod.6.fit, c("cfi")) 
mod8_srmr<-fitMeasures(lvmod.6.fit, c("srmr")) 
mod8_rmsea<-fitMeasures(lvmod.6.fit, c("rmsea")) 
mod8_rmseaLC<-fitMeasures(lvmod.6.fit, c("rmsea.ci.lower")) 
mod8_rmseaUP<-fitMeasures(lvmod.6.fit, c("rmsea.ci.upper")) 

ModFit_table<-matrix(c(mod1_cq,mod2_p, mod1_df,mod2_cfi,mod1_srmr,mod1_rmsea,mod1_rmseaLC,mod1_rmseaUP,
                       mod2_cq,mod2_p, mod2_df,mod2_cfi,mod2_srmr,mod2_rmsea,mod2_rmseaLC,mod2_rmseaUP,
                       mod3_cq,mod3_p, mod3_df,mod3_cfi,mod3_srmr,mod3_rmsea,mod3_rmseaLC,mod3_rmseaUP,
                       mod4_cq,mod4_p, mod4_df,mod4_cfi,mod4_srmr,mod4_rmsea,mod4_rmseaLC,mod4_rmseaUP,
                       mod5_cq,mod5_p, mod5_df,mod5_cfi,mod5_srmr,mod5_rmsea,mod5_rmseaLC,mod5_rmseaUP,
                       mod6_cq,mod6_p, mod6_df,mod6_cfi,mod6_srmr,mod6_rmsea,mod6_rmseaLC,mod6_rmseaUP,
                       mod7_cq,mod7_p, mod7_df,mod7_cfi,mod7_srmr,mod7_rmsea,mod7_rmseaLC,mod7_rmseaUP,
                       mod8_cq,mod8_p, mod8_df,mod8_cfi,mod8_srmr,mod8_rmsea,mod8_rmseaLC,mod8_rmseaUP,
                       'Low chi-square relative to degrees of freedom with an insignificant p value (p > 0.05)', '', '', '>0.90',  '<0.08','<0.07', '', '',
                       '{Grace, 2006 #1061}', '', '',  '{Lefcheck, 2019 #1157; Hu, 1999 #321}', '{Hu, 1999 #321}', '{Steiger, 2007#1162}','',''),ncol=8,byrow=TRUE)
colnames(ModFit_table) <- c("Chi-square","p-value","DF", "CFI", "SRMR", "RMSEA", "Lower RMSEA", "Upper RMSEA" )
rownames(ModFit_table) <- c("Energy store model (Fig. 2a, Code S1)", "Bill colour model (Fig. 2b, Code S2)", "Composite model (Fig. 4, Code S3)","Composite model with squared mass (Code S4)" , "Latent+composite model (Fig. 5, Code S5)","Full model with direct and indirect effect of body size (Fig. S13a, Code S6)","Full model with indirect effect of body size (Fig S13b, Code S7)","Model used for model performance (Fig. 6, Code S8)", "Acceptable threshold levels", "Literature")

ModFit_table
```

Table S7
```{r echo=F}
kable(ModFit_table,digits=2, format="pandoc", caption="Table S5: Model fit indices of all models. Statistical significance of the chi-square statistic (using alpha = 0.05) indicates that exact fit of the model has to be rejected. With increasing sample sizes, chance of detecting a smaller difference between the hypothesized value and the true value is greater and therefore may lead to rejection of the model. Since we have to deal with relatively high sample sizes (>300), we also document measures of approximate fit: the root mean square error of approximation (RMSEA), standardized root mean square residual (SRMR) and the comparative fit index (CFI).")
```

Descriptive supplementary information (Table S1, Table S2, Fig. S2, Fig. S24)
```{r include=F}
# Table S1
k<-subset(data,
          select=c(BirdId, Age, ObsCatchNr,Area, YP,Latitude,Longitude,CapDate,SampleYear))
k<-subset(k,YP==2)
summary(k)
table(k$ObsCatchNr, k$Area)
t<-table(k$ObsCatchNr, k$Age)
t


m2<-k %>% 
  group_by(ObsCatchNr,Age) %>% 
  tally()

m3 <- m2 %>%
  tidyr::spread(key = Age, value = n)

k1<-subset(k,
          select=c(CapDate,Area,Longitude,Latitude,SampleYear,ObsCatchNr))
summary(k1)
m1 <-
k1 %>% 
  arrange(ObsCatchNr)%>%
  group_by(ObsCatchNr)%>%
  filter(row_number()==1)

SupplTable1<-left_join(m1,m3,by="ObsCatchNr")

colnames(SupplTable1) <- c("Date","Location","Longitude", "Latitude", "Winter", "Catching event ID", "Number of 1st CY birds", "Number of Sub-Adults", "Number of Adults")
kable(SupplTable1,digits=3, format="pandoc", caption="Table S1: Descriptive Statistics for Observed Variables")
```

```{r echo=F}
kable(SupplTable1,digits=2, format="pandoc", caption="Table S1: Catching events and their characteristics.")
```

```{r, echo = FALSE, fig.cap="\\label{fig:figs}Figure S24: Corticosterone (pg/mg) measurements for the two different years of extraction (2016-2017 & 2017-2018)"}
ggplot(CortSuppl, aes(x=Cort, color=Year)) +
  geom_histogram(fill="white", alpha=0.5, position="dodge", bins=50)+
  geom_vline(data=mu, aes(xintercept=mean, color=Year),
             linetype="dashed")+
  xlab("Corticosterone (pg/mg)") + ylab("Frequency")
```

```{r, include=FALSE}
df<-subset(d, Age=="Adult")
s<-df %>% 
  select(MS:BH,TH, WL,H, B, Cho_perVolBlood, U_perVolBlood, CortStd,HS,LS,CS,HT,Density, SurvWS) %>% 
  gather("Variable", "value") %>% 
  group_by(Variable)
s

s$Variable<-factor(s$Variable)
cdata <- ddply(s, c("Variable"), summarise,
               Mean = mean(value, na.rm=TRUE),
               SD   = sd(value,na.rm=TRUE),
               min    = min(value,na.rm=TRUE),
               max=max(value, na.rm=TRUE), 
               NrObs=length(Variable[!is.na(value)]))
cdata

kable(cdata,digits=3, format="pandoc", caption="Table S2: Descriptive Statistics for Observed Variables")

kable_out <- knitr::kable(cdata, "html", digits=3) %>% kableExtra::kable_styling(bootstrap_options = c("striped", "hover"))
readr::write_file(kable_out, "kable_out.html")
```


```{r, include=FALSE}
z2<-subset(d,
           select=c(MS, TA, BH,TH, WL,H, B, Cho, U, CortStd,HS,LS,CS,HT,DS,Density))
summary(z2)
z2<-na.omit(z2)

#ratio
z2$ratio<-z2$MS/z2$TA
summary(z2)

#residuals
m2<-lm(MS~TA+WL+TH, data=z2)
z2$Residuals<-resid(m2)

# First we need to take care of some weird variable names
colnames(z2)[colnames(z2)=="MS"] <- "Mass"
colnames(z2)[colnames(z2)=="TA"] <- "Tarsus length"
colnames(z2)[colnames(z2)=="BH"] <- "Bill tip height"
colnames(z2)[colnames(z2)=="TH"] <- "Head/bill length"
colnames(z2)[colnames(z2)=="WL"] <- "Wing length"
colnames(z2)[colnames(z2)=="H"] <- "Haematorcrit"
colnames(z2)[colnames(z2)=="B"] <- "Buffy coat"
colnames(z2)[colnames(z2)=="Cho"] <- "Cholesterol"
colnames(z2)[colnames(z2)=="U"] <- "Uric acid"
colnames(z2)[colnames(z2)=="CortStd"] <- "Corticosterone"
colnames(z2)[colnames(z2)=="HS"] <- "Bill hue"
colnames(z2)[colnames(z2)=="LS"] <- "Bill luminance"
colnames(z2)[colnames(z2)=="CS"] <- "Bill chroma"
colnames(z2)[colnames(z2)=="HT"] <- "Handling time"
colnames(z2)[colnames(z2)=="DS"] <- "Day in the season"
colnames(z2)[colnames(z2)=="Density"] <- "Oystercatcher density (nr/km2)"
colnames(z2)[colnames(z2)=="ratio"] <- "Ratio"
colnames(z2)[colnames(z2)=="Residuals"] <- "Residuals"

c<-cor(z2)
col <- colorRampPalette(c("#4477AA", "#77AADD","#FFFFFF", "#EE9988","#BB4444" ))
```

```{r, echo = FALSE,fig.width=10,fig.height=10, fig.cap="\\label{fig:figs}Figure S2: Correlation matrix of all variables in the dataset."}
##################################################################
### plot matrix#####################################################
corrplot(c, method="color", col=col(200),  
         type="upper", #order="hclust", 
         addCoef.col = "black", # Add coefficient of correlation
         tl.col="black", tl.srt=45, #Text label color and rotation
         # Combine with significance
         #p.mat = p.mat, sig.level = 0.01, insig = "blank", 
         # hide correlation coefficient on the principal diagonal
         diag=FALSE, number.cex=0.75)
```

Code S10: Example r-code to account for a measurement error (in a regression analysis; mass as response variable and three structural size measures as independent variables) by using latent variables in SEM. We assume a reapatability of 0.3 of the strctural size measures TA, TH and WL. We add three latent variables lTA, lTH, lWL to the model. Instead of regressing the strucural size measures directly on mass, we regress the latent variables of the structural size measures on mass (lTA, lWL, lTH). By adding the latent variables to the model, we can distinguish between the error variance due to unexplained variation and due to measurement error. In the output of this model, we find the unexplained variation for each structural size variable (without any influence of measurement error). The R-package used for the analysis is lavaan. See chapter 4 in for more information about accounting for measurement errors in SEM.
```{r}
lvmod.3 <-'
lTA=~TA         # define the latent variable lTA 
lWL=~WL         # define the latent variable lWL 
lTH=~TH         # define the latent variable lTH 
TA~~0.7*TA      # add error variance on TA
TH~~0.7*TH      # add error variance on TH
WL~~0.7*WL      # add error variance on WL
MS~lTA+lTH+lWL  # regress the three latent variables on mass
'
lvmod.3.fit<-sem(lvmod.3,data=d) #fit the model
summary(lvmod.3.fit, rsq=T, standardized=T) #get model output
```

Import and prepare data for the binomial model (Code S11)
```{r include=F}
rm(list = ls())
data<-read.csv("dataCodeS11.csv", header=T,dec=",", sep=";") 

data$SeenF<-factor(data$SeenF)
d<-data
```

Code S11: Example r-code for a model with binomial response variable. In this example we defined a bird that was seen in the subsequent year (after catching) as 1 and otherwise as 0. We show here an example of a simple composite model (similar to Figure 5) without any confounding variables. The R-package used for the analysis is lavaan.
```{r warning=F}
d$Seen1<-ordered(d$Seen) #define the numeric binomial response variable "Seen" (1/0) to be ordered

Cmod.6 <- '
  Comp <~ 1*MS+Cho_perVolBlood+LogitB+LogitH+U_perVolBlood+Cort   #define the composite variable
  MS~TA   # regress tarsus length on mass to correct for size effect on mass
  Seen1~Comp  # use Seen1 as binomial response variable
'

Cmod.6.fit<-sem(Cmod.6,data=d, ordered ="Seen1", estimator="WLSMV") #estimator WLSMV needs to be used when dealing with binomial response variables, define ordered="Seen1" to tell the model that the response variable is binomial
summary(Cmod.6.fit, rsq=T, standardized=T) #get model output
fitmeasures(Cmod.6.fit, c("chisq", "pvalue", "df","cfi", "srmr", "rmsea", "rmsea.ci.lower", "rmsea.ci.upper")) #get model fit indices
```
